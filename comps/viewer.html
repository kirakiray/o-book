<template component>
  <l-m
    src="https://cdn.jsdelivr.net/npm/iconify-icon@2.0.0/dist/iconify-icon.min.js"
  ></l-m>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/list/list.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
    }
    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .top {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      padding: 8px 8px;
      background-color: var(--md-sys-color-on-primary);
      box-shadow: rgba(128, 128, 128, 0.3) 0 0 5px;
    }

    .top > * {
      margin: 0 4px;
    }

    .main {
      display: flex;
      flex: 1;
    }

    .left {
      width: 250px;
    }

    .article-list {
      width: 250px;
      height: 100%;
      background-color: var(--md-sys-color-on-primary);
    }
    .article-list p-list {
      margin-left: 12px;
    }

    .article-list iconify-icon[slot="prefix"] {
      font-size: 18px;
    }

    /* .article-list p-list-item {
      font-size: 13px;
    } */

    .article {
      position: relative;
      flex: 1;
    }

    .article textarea {
      position: absolute;
      box-sizing: border-box;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      padding: 16px;
      resize: none;
      border: none;
      background-color: var(--md-sys-color-surface);
      outline: none;
    }
  </style>
  <div class="container">
    <div class="top">
      <p-select :value="lang" size="small">
        <x-fill :value="langOptions">
          <option attr:value="$data.lang">{{$data.name}}</option>
        </x-fill>
      </p-select>
      <p-button size="small" icon on:click="emit('reload')">
        <iconify-icon icon="mdi:reload"></iconify-icon>
      </p-button>
      <p-button
        size="small"
        style="margin-left: auto"
        on:click="clickSave"
        attr:disabled="oldFileText === filetext ? '' : null "
      >
        <x-if :value="saving">
          <iconify-icon icon="eos-icons:loading" slot="prefix"></iconify-icon>
        </x-if>
        <x-else>
          <iconify-icon
            icon="material-symbols:save-outline"
            slot="prefix"
          ></iconify-icon>
        </x-else>
        保存
      </p-button>
    </div>
    <div class="main">
      <div class="left">
        <p-list class="article-list">
          <x-fill :value="summarys" name="list-item"> </x-fill>
        </p-list>
      </div>
      <div class="article">
        <!-- <slot></slot> -->
        <textarea sync:value="filetext"></textarea>
      </div>
    </div>
  </div>

  <template name="list-item">
    <p-list-item
      attr:button="$data?.list?.length ? null : 1"
      radius
      on:click="$host.clickFile($data)"
      attr:active-item="$data.url === $host.activeUrl ? 1 : null"
    >
      <x-if :value="$data.list && $data.list.length">
        <iconify-icon
          icon="gravity-ui:folder-open"
          slot="prefix"
        ></iconify-icon>
        <b> {{$data.name}}</b>
        <p-list slot="childs">
          <x-fill :value="$data.list" name="list-item"></x-fill>
        </p-list>
      </x-if>
      <x-else>
        <x-if :value="$data.ftype === 'md'">
          <iconify-icon
            icon="ant-design:file-markdown-outlined"
            slot="prefix"
          ></iconify-icon>
        </x-if>
        <x-else-if :value="$data.ftype === 'html'">
          <iconify-icon icon="ph:file-html" slot="prefix"></iconify-icon>
        </x-else-if>
        <x-else>
          <iconify-icon
            icon="material-symbols:article-outline"
            slot="prefix"
          ></iconify-icon>
        </x-else>
        {{$data.name}}
        <p-button slot="suffix" size="small" icon style="z-index: 3">
          <a attr:href="$data.url" target="_blank">
            <iconify-icon icon="fluent:open-16-filled"> </iconify-icon>
          </a>
        </p-button>
      </x-else>
    </p-list-item>
  </template>
  <script>
    export default async ({ load }) => {
      const { confirm } = await load("@pui/dialog/command.js");
      const { default: enqueue } = await load(`@pui/snackbar/enqueue.js`);

      return {
        tag: "article-viewer",
        data: {
          lang: "", // 展示中的语言
          langOptions: [], // 可用语言的选项
          summarys: [], // 左侧的大纲
          activeUrl: "", // 激活中的url
          oldFileText: "", // 选中文件未保存前的文本
          filetext: "", // 选中中的文本内容
          _targetHandle: null, // 选中文件的控制器
          saving: false, // 是否保存中
        },
        proto: {
          async clickSave() {
            if (this.saving || this.oldFileText === this.filetext) {
              return;
            }

            this.saving = true;
            await this._targetHandle.write(this.filetext);
            this.oldFileText = this.filetext;
            this.saving = false;
            enqueue({
              content: "保存成功",
            });
          },
          async clickFile(data) {
            if (data.list) {
              return;
            }
            if (this.oldFileText !== this.filetext) {
              const result = await confirm({
                title: "未保存",
                content: `修改的内容尚未保存，是否切换到另一个页面？`,
              });

              if (result === false) {
                return;
              }
            }

            const { host } = this;
            let realPath = data.url.replace(host._server.path + "/", "");
            realPath = realPath.replace(
              new RegExp(`(.+)\\..+$`),
              "$1." + data.ftype
            );

            const targetHandle = (this._targetHandle = await host._handle.get(
              realPath
            ));
            const filetext = await targetHandle.text();

            this.activeUrl = data.url;

            this.oldFileText = this.filetext = filetext;
          },
        },
        watch: {
          summarys(summarys) {
            console.log("summarys: ", summarys.toJSON());

            setTimeout(() => {
              const target = this.shadow.$("p-list-item[button]");
              if (target) {
                target.ele.click();
              }
            }, 100);
          },
        },
        attached() {
          window.addEventListener("keydown", (e) => {
            if (e.metaKey && e.key === "s") {
              e.preventDefault();
              this.clickSave();
            }
          });
        },
      };
    };
  </script>
</template>
