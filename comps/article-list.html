<template component>
  <l-m
    src="https://cdn.jsdelivr.net/npm/iconify-icon@2.0.0/dist/iconify-icon.min.js"
  ></l-m>
  <l-m src="@pui/list/list.html"></l-m>

  <style>
    :host {
      display: block;
      height: 100%;
      background-color: var(--md-sys-color-on-primary);
    }

    .article-list {
      box-sizing: border-box;
      width: 250px;
      padding: 0 4px;
      height: 100%;
    }
    .article-list p-list {
      margin-left: 12px;
    }

    .article-list iconify-icon[slot="prefix"] {
      font-size: 18px;
    }
  </style>

  <x-if :value="showyaml === null">
    <style>
      p-list-item[item-name$=".yaml"] {
        display: none;
      }
    </style>
  </x-if>

  <p-list class="article-list">
    <div style="height: 12px"></div>
    <div>{{error_text}}</div>
    <x-fill :value="summarys" name="list-item"> </x-fill>
  </p-list>

  <template name="list-item">
    <p-list-item
      attr:button="$data?.list?.length ? null : 1"
      radius
      on:click="$host.clickSummaryItem($data)"
      attr:active-item="$data.path === $host.activePath ? 1 : null"
      attr:item-name="$data.name"
    >
      <x-if :value="$data.list && $data.list.length">
        <iconify-icon
          icon="gravity-ui:folder-open"
          slot="prefix"
        ></iconify-icon>
        <b> {{$data.name}}</b>
        <p-list slot="childs">
          <x-fill :value="$data.list" name="list-item"></x-fill>
        </p-list>
      </x-if>
      <x-else>
        <x-if :value="/.md$/.test($data._handle.name)">
          <iconify-icon
            icon="ant-design:file-markdown-outlined"
            slot="prefix"
          ></iconify-icon>
        </x-if>
        <x-else-if :value="/.html$/.test($data._handle.name)">
          <iconify-icon icon="ph:file-html" slot="prefix"></iconify-icon>
        </x-else-if>
        <x-else>
          <iconify-icon
            icon="material-symbols:article-outline"
            slot="prefix"
          ></iconify-icon>
        </x-else>
        <!-- {{$data.title || $data.name}} -->
        <div style="display: flex; align-items: center">
          {{$data.name}}
          <span class="item-mark" style="margin-left: 8px"></span>
        </div>
      </x-else>
    </p-list-item>
  </template>

  <script>
    import { getSummary, currentData, getFileList } from "../src/data.js";

    export default {
      tag: "article-list",
      attrs: {
        showyaml: null,
      },
      data: {
        summarys: [],
        activePath: "",
        error_text: "",
      },
      proto: {
        async clickSummaryItem(data) {
          if (!data.path) {
            return;
          }

          this.emit("click-item", {
            data: {
              item: data,
              handle: data._handle,
            },
          });

          this.activePath = data.path;
        },
        async reload() {
          try {
            const data = await getFileList("cn");
            // const summarys = await getSummary({ lang: "cn" });
            console.log("test: ", data);

            this.summarys = data.list;
          } catch (err) {
            this.error_text = err.toString();
          }

          this.reloadItemMark();
        },
        // 刷新左侧列表项的外观
        reloadItemMark(fileName) {
          if (this.host._fixItem) {
            setTimeout(
              async () => {
                const items = this.shadow.all("p-list-item");

                if (items.length) {
                  await Promise.all(
                    items.map(async (e) => {
                      if (fileName && e.attr("item-name") !== fileName) {
                        return;
                      }

                      const markEl = e.$(".item-mark");

                      if (markEl) {
                        // 向宿主运行数据，返回填充的内容
                        const reData = await this.host._fixItem(e.__item.$data);

                        if (reData) {
                          markEl.html = reData;
                        } else {
                          markEl.html = "";
                        }
                      }
                    })
                  );
                }
              },
              fileName ? 100 : 500
            );
          }
        },
      },
      watch: {
        summarys(summarys) {
          if (!summarys.length) {
            return;
          }

          setTimeout(() => {
            if (!this.activePath) {
              this.shadow.$("p-list-item[button]").ele.click();
            }
          }, 100);
        },
      },
      async attached() {
        this.reload();
      },
    };
  </script>
</template>
