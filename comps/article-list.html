<template component>
  <l-m
    src="https://cdn.jsdelivr.net/npm/iconify-icon@2.0.0/dist/iconify-icon.min.js"
  ></l-m>
  <l-m src="@pui/list/list.html"></l-m>

  <style>
    :host {
      display: block;
      height: 100%;
      background-color: var(--md-sys-color-on-primary);
    }

    .article-list {
      box-sizing: border-box;
      width: 250px;
      padding: 0 4px;
      height: 100%;
    }
    .article-list p-list {
      margin-left: 12px;
    }

    .article-list iconify-icon[slot="prefix"] {
      font-size: 18px;
    }
  </style>

  <p-list class="article-list">
    <div style="height: 12px"></div>
    <div>{{error_text}}</div>
    <x-fill :value="summarys" name="list-item"> </x-fill>
  </p-list>

  <template name="list-item">
    <p-list-item
      attr:button="$data?.list?.length ? null : 1"
      radius
      on:click="$host.clickSummaryItem($data)"
      attr:active-item="$data.path === $host.activePath ? 1 : null"
    >
      <x-if :value="$data.list && $data.list.length">
        <iconify-icon
          icon="gravity-ui:folder-open"
          slot="prefix"
        ></iconify-icon>
        <b> {{$data.name}}</b>
        <p-list slot="childs">
          <x-fill :value="$data.list" name="list-item"></x-fill>
        </p-list>
      </x-if>
      <x-else>
        <x-if :value="/.md$/.test($data._handle.name)">
          <iconify-icon
            icon="ant-design:file-markdown-outlined"
            slot="prefix"
          ></iconify-icon>
        </x-if>
        <x-else-if :value="/.html$/.test($data._handle.name)">
          <iconify-icon icon="ph:file-html" slot="prefix"></iconify-icon>
        </x-else-if>
        <x-else>
          <iconify-icon
            icon="material-symbols:article-outline"
            slot="prefix"
          ></iconify-icon>
        </x-else>
        <!-- {{$data.title || $data.name}} -->
        {{$data.name}}
      </x-else>
    </p-list-item>
  </template>

  <script>
    import { getSummary, currentData, getFileList } from "../src/data.js";

    export default {
      tag: "article-list",
      data: {
        summarys: [],
        activePath: "",
        error_text: "",
      },
      proto: {
        async clickSummaryItem(data) {
          if (!data.path) {
            return;
          }

          this.emit("click-item", {
            data: {
              item: data,
              handle: data._handle,
            },
          });

          this.activePath = data.path;
        },
      },
      watch: {
        summarys(summarys) {
          if (!summarys.length) {
            return;
          }

          setTimeout(() => {
            if (!this.activePath) {
              this.shadow.$("p-list-item[button]").ele.click();
            }
          }, 100);
        },
      },
      async attached() {
        try {
          const data = await getFileList("cn");
          // const summarys = await getSummary({ lang: "cn" });
          console.log("test: ", data);

          // this.summarys = summarys;
          this.summarys = data.list;
        } catch (err) {
          this.error_text = err.toString();
        }
      },
    };
  </script>
</template>
