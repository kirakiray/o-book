<template page>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/select/select.html"></l-m>
  <l-m src="@pui/list/list.html"></l-m>
  <l-m src="../comps/viewer.html"></l-m>
  <style>
    :host {
      display: contents;
    }
    .container {
      height: 100%;
      /* background-color: red; */
    }
  </style>
  <div class="container">
    <x-if :value="!lang">
      <div style="padding: 0 16px">
        <p>
          这个webapp的所有操作只会在浏览器本地执行，不会上传到服务端。借助这个webapp，你不需要学习和使用什么命令行代码，不需要安装软件到你的系统上，就能生成好看好用的文档静态站。
        </p>
        <p-button on:click="selectDir" attr:disabled="entryLink ? '' : null">
          选择文件夹
        </p-button>
      </div>
    </x-if>
    <x-if :value="lang">
      <article-viewer
        :lang="lang"
        :lang-options="langOptions"
        :summarys="summarys"
      >
        <!-- <p>
          <a attr:href="entryLink + 'cn/index.html'" target="_blank">Entry</a>
          <br />
          <a attr:href="entryLink + '_statics/'" target="_blank">Static</a>
          <br />
          <a attr:href="entryLink + 'cn/config.json'" target="_blank">
            Config.json
          </a>
          <br />
          <a attr:href="entryLink + 'cn/_articles.json'" target="_blank">
            articles.json
          </a>
        </p> -->
      </article-viewer>
    </x-if>
  </div>

  <script>
    export const parent = "./layout.html";

    import { create } from "../src/mdserver.js";

    export default async ({ load }) => {
      const { open } = await load("@nos/core/fs/system/main.js");

      return {
        data: {
          entryLink: null,
          articleTemp: "", // 正文模板内容
          lang: "", // 展示中的语言
          langOptions: [],
          // configData: {},
          summarys: [],
        },
        proto: {
          async selectDir() {
            const handle = await open();

            this._server = await create({
              handle,
              temp: this.articleTemp,
            });

            this.entryLink = this._server.path + "/";

            this.reload();
          },
          async reload() {
            const { allDatas } = this._server;

            this.langOptions = allDatas.map((e) => {
              let name = "";
              const { lang } = e;

              switch (lang) {
                case "cn":
                  name = "简体中文";
                  break;
                case "t-cn":
                  name = "繁体中文";
                  break;
                case "en":
                  name = "English";
                  break;
              }

              return {
                lang,
                name,
              };
            });

            this._alls = allDatas;

            const target = allDatas[0];

            this.lang = target.lang;

            this.summarys = fixSummary(target.data.summarys, {
              entryLink: this.entryLink,
              lang: this.lang,
            });

            console.log(target.data.summarys);
          },
        },
        ready() {
          fetch("/statics/index.html")
            .then((e) => e.text())
            .then((text) => {
              this.articleTemp = text;
            });
        },
      };
    };

    const fixSummary = (list, opts) => {
      return list.map((item) => {
        if (item.list) {
          return {
            ...item,
            list: fixSummary(item.list, {
              rootDir: opts.rootDir || item.dirName,
              ...opts,
            }),
          };
        }

        return {
          ...item,
          url: `${opts.entryLink}${opts.lang}/${opts.rootDir}/${item.path}`,
        };
      });
    };
  </script>
</template>
