<template page>
  <l-m src="@pui/button/button.html"></l-m>
  <style>
    :host {
      display: contents;
    }
    .container {
      padding: 20px;
      height: 100%;
      /* background-color: red; */
    }
  </style>
  <div class="container">
    <p>
      这个webapp的所有操作只会在浏览器本地执行，不会上传到服务端。借助这个webapp，你不需要学习和使用什么命令行代码，不需要安装软件到你的系统上，就能生成好看好用的文档静态站。
    </p>
    <p-button on:click="selectDir" attr:disabled="entryLink ? '' : null">
      选择文件夹
    </p-button>
    <x-if :value="entryLink">
      <p>
        <a attr:href="entryLink + 'cn/index.html'" target="_blank">Entry</a>
        <br />
        <a attr:href="entryLink + '_statics/'" target="_blank">Static</a>
        <br />
        <a attr:href="entryLink + 'cn/config.json'" target="_blank"
          >Config.json</a
        >
      </p>
    </x-if>
  </div>

  <script>
    import yaml from "https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.mjs";
    import { statics, config as configTask, respPage } from "../src/tasks.js";
    import { getAllArticles } from "../src/util.js";
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { open } = await load("@nos/core/fs/system/main.js");
      const { createApi } = await load("@nos/core/virtual.js");

      return {
        data: {
          entryLink: null,
          _handle: null,
          mainLang: "cn",
          _allDatas: [],
          articleTemp: "", // 正文模板内容
        },
        proto: {
          async selectDir() {
            const handle = (this._handle = await open());

            const allDatas = [];

            for await (let [name, subHandle] of handle.entries()) {
              if (subHandle.kind === "directory" && !/^_/.test(name)) {
                const navData = await this.getNavData(subHandle);
                allDatas.push({
                  lang: name,
                  data: navData,
                });
              }
            }

            this._allDatas = allDatas;

            console.log("all: ", allDatas);

            this.initServer();
          },
          async getNavData(handle) {
            // const handle = await this._handle.get(lang);

            const articleData = await getAllArticles(handle);

            let configData = await handle
              .get("config.yaml")
              .then((e) => e.text());

            configData = yaml.load(configData);

            return {
              articleData,
              configData,
            };
          },
          async initServer() {
            const _this = this;
            const server = createApi({
              name: this._handle.name,
              async callback({
                request,
                search,
                pathname,
                searchParams,
                hash,
              }) {
                console.log(request, search, pathname, searchParams, hash);

                const path = pathname.replace(/^\//, "");

                for (let task of [statics, configTask, respPage]) {
                  const result = await task({
                    path,
                    all: _this._allDatas,
                    handle: _this._handle,
                    temp: _this.articleTemp,
                  });

                  if (result) {
                    return result;
                  }
                }

                return {
                  body: "ok la -- " + path,
                };
              },
              created: () => {
                this.entryLink = `${server.path}/`;
              },
            });
          },
        },
        ready() {
          // this.initServer();
          fetch("/statics/index.html")
            .then((e) => e.text())
            .then((text) => {
              this.articleTemp = text;
            });
        },
      };
    };
  </script>
</template>
