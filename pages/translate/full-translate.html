<template component>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/dialog/dialog.html"></l-m>
  <p-button
    size="small"
    :disabled="translatedCount >= needTranslateCount ? '' : null"
    on:click="clickTranslate"
  >
    <x-if :value="opened">
      翻译中...({{translatedCount}} / {{needTranslateCount}})
    </x-if>
    <x-else-if :value="translatedCount === needTranslateCount">
      翻译完成 ({{translatedCount}} / {{needTranslateCount}})
    </x-else-if>
    <x-else>
      翻译未翻译的段落 ({{translatedCount}} / {{needTranslateCount}})
    </x-else>
  </p-button>

  <!-- <p-dialog :open="opened" fullscreen="540">
    <span slot="title">翻译全文</span>
  </p-dialog> -->
  <script>
    import {
      currentData,
      configDataByLang,
      getFileList,
    } from "../../src/data.js";

    import { getHashFingerprint, getArticleParts } from "../../src/util.js";
    import { translate } from "./translate.js";
    import { savePart, getPart } from "./part-manager.js";

    export default {
      tag: "full-translate",
      data: {
        lang: null,
        opened: false,
        translatedCount: 0, // 当前翻译段落的数量
        needTranslateCount: 0, // 总共需要翻译的段落数
      },
      watch: {
        lang(lang) {
          console.log("lang", lang);
        },
      },
      proto: {
        clickTranslate() {
          this.opened = true;
          this.statistical(true);
        },
        // 获取所有的文章，并统计段落的数量和获取hash
        async statistical(runTranslate = false) {
          const { handle } = currentData;

          // 源文档语言
          const originLang = "cn";

          // 所有段落的字符串集合
          const raws = [];

          const getRaws = async (dir) => {
            for (let item of dir.list) {
              if (item.kind === "directory") {
                await getRaws(item);
              } else {
                const handle = item._handle;

                const content = await getArticleParts({
                  content: await handle.text(),
                  name: handle.name,
                });

                raws.push(...content.map((e) => e.raw));
              }
            }
          };

          await getRaws(await getFileList(originLang));

          this.needTranslateCount = raws.length;

          // 计算已经翻译的个数
          this.statisticalTranslated(raws, runTranslate);
        },
        // 统计已翻译的个数
        async statisticalTranslated(raws, runTranslate) {
          this.translatedCount = 0;

          // 转换好后，存放到本地缓存
          for (let item of raws) {
            const content = item.trim();
            const hash = await getHashFingerprint(content);

            const translatedText = await getPart({
              lang: this.lang,
              hash,
            });

            // 判断是否存在，不存在才翻译
            if (!translatedText) {
              if (!runTranslate) {
                continue;
              }
              const result = await translate({
                content,
              });

              await savePart({
                lang: this.lang,
                hash,
                content: result.context,
              });
            }

            this.translatedCount++;
          }

          this.opened = false;
        },
      },
      attached() {
        this.statistical();
      },
    };
  </script>
</template>
