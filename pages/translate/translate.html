<template page>
  <l-m src="@pui/select/select.html"></l-m>
  <l-m src="@pui/button/button.html"></l-m>
  <l-m src="@pui/progress/progress.html"></l-m>
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
      overflow: auto;
    }
    .container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      min-height: 400px;
      font-size: 20px;
    }

    h4,
    p {
      margin: 0.25em 0;
    }

    p-select {
      display: inline-block;
      width: 150px;
    }
  </style>
  <div class="container">
    <h4>AI翻译功能</h4>
    <p>
      o-book会使用你本机的 ollama AI进行，请确保本机已经安装
      <a target="_blank" href="https://ollama.com/">Ollama</a>
    </p>

    <x-if :value="translateState === 0">
      <div>
        请选择要翻译到什么语言：
        <p-select sync:value="targetlang">
          <option value="en">英语</option>
          <option value="sp">西班牙语</option>
          <option value="jp">日语</option>
          <option value="ko">韩语</option>
        </p-select>
        <p-button attr:disabled="targetlang ? null : ''" on:click="totalCount">
          确定
        </p-button>
      </div>
    </x-if>
    <x-else-if :value="translateState === 1">
      <div>正在统计段落</div>
    </x-else-if>
    <x-else-if :value="translateState === 2">
      <div>开始翻译段落</div>
      <div>{{translatedCount}} / {{pCount}}</div>

      <p-progress
        :value="translatedCount / pCount * 100"
        style="width: 50%"
      ></p-progress>
    </x-else-if>
  </div>

  <script>
    export const parent = "../layout.html";

    import { EverCache } from "https://cdn.jsdelivr.net/gh/kirakiray/ever-cache@1.0.4/src/main.js";
    import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
    import { getHashFingerprint } from "../../src/util.js";
    import { translate } from "./translate.js";
    import { savePart, getPart } from "./part-manager.js";

    export default async ({ load }) => {
      const { currentData, configDataByLang } = await load("../../src/data.js");

      return {
        data: {
          targetlang: "", // 翻译到目标语言
          translateState: 0,
          pCount: 0, // 总共需要翻译的段落数
          translatedCount: 0, // 当前翻译段落的数量
        },
        proto: {
          // 获取所有的文章，并统计段落的数量和获取hash
          async totalCount(e) {
            this.translateState = 1;

            const { handle } = currentData;

            const lang = "cn";

            // 获取源语言的数据
            const target = await configDataByLang(lang);

            const paths = target.articles.map((e) => `${lang}/${e.path}`);

            // 所有段落数
            let count = 0;
            let raws = [];

            // 获取所有正文
            const articles = await Promise.all(
              paths.map(async (path) => {
                let isMd = false;
                const tartgetHandle = await handle.get(path).catch((err) => {
                  isMd = true;
                  return handle.get(path.replace(/\.html$/, ".md"));
                });

                const content = await tartgetHandle.text();

                let paragraph;

                // 将内容进行转换
                if (isMd) {
                  const parts = marked.lexer(content);
                  paragraph = parts.map((e) => e.raw);
                } else {
                  const temp = $(`<template>${content}</template>`);
                  paragraph = Array.from(temp.ele.content.children).map(
                    (el) => el.outerHTML
                  );
                }

                paragraph = paragraph.filter((text) => {
                  const content = text.trim();
                  if (content && content !== "<br>") {
                    return true;
                  }

                  return false;
                });

                count += paragraph.length;

                raws.push(...paragraph);

                return {
                  path,
                  content,
                  paragraph,
                  isMd,
                };
              })
            );

            this.pCount = count;
            this.translateState = 2;

            this.translate(raws);
          },
          // 开发翻译正文
          async translate(raws) {
            // 转换好后，存放到本地缓存
            for (let item of raws) {
              const content = item.trim();
              const hash = await getHashFingerprint(content);

              const translatedText = await getPart({
                lang: this.targetlang,
                hash,
              });

              // 判断是否存在，不存在才翻译
              if (!translatedText) {
                const result = await translate({
                  content,
                });

                await savePart({
                  lang: this.targetlang,
                  hash,
                  content: result.context,
                });
              }

              this.translatedCount++;
            }

            this.goto(`./translate-confirm.html?lang=${this.targetlang}`);
          },
        },
      };
    };
  </script>
</template>
