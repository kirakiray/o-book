<template component>
  <div>我是book生成器辅助工具</div>
  <script>
    import { getSummary } from "../statics/util.mjs";

    export default {
      attrs: {
        src: "",
        sw: "",
      },
      watch: {
        async src(src) {
          if (this.__src) {
            throw "The src attribute is already in effect and cannot be changed.";
          }
          if (!src) {
            return;
          }

          this.__src = src;

          const configUrl = new URL(src, location.href).href;

          const cdata = await fetch(configUrl).then((e) => e.json());

          const { navs } = cdata;

          await Promise.all(
            navs.map(async (e) => {
              const { summary } = e;

              const summaryUrl = new URL(summary, configUrl).href;

              const data = await getSummary(summaryUrl);

              e.articles = data;
            })
          );

          localStorage.__configData = JSON.stringify(cdata);

          console.log("configData: ", cdata);
        },
        sw(sw) {
          if (this.__sw) {
            throw "The sw attribute is already in effect and cannot be changed.";
          }
          if (!sw) {
            return;
          }

          navigator.serviceWorker
            .register(new URL(sw, location.href).href, {
              scope: "./",
            })
            .then((reg) => {
              setTimeout(() => {
                reg.update();
              }, 60 * 60 * 1000);
            })
            .catch((err) => {
              console.error(err);
            });
        },
      },
    };
  </script>
</template>
